name: VISION CI/CD Pipeline

# 当推送到 main 分支时触发
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  # 任务 1: 检查前端文件完整性
  check-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Verify HTML Structure
      run: |
        if [ -f index.html ]; then
          echo "index.html exists."
        else
          echo "Error: index.html missing!"
          exit 1
        fi

  # 任务 2: 构建 Go 工具
  build-go-cli:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
    - name: Build Go CLI
      run: |
        cd tools
        go build -v -o vision-cli main.go

  # 任务 3: 测试 Rust 核心
  build-rust-core:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    - name: Check Rust Syntax
      run: |
        cd core
        cargo check --verbose

  # 任务 4: 模拟 Docker 构建
  docker-build:
    runs-on: ubuntu-latest
    needs: [check-frontend]
    steps:
    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag vision-parser:latest
